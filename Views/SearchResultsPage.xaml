<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:MauiFrontend.ViewModels"
             xmlns:mi="http://www.aathifmahir.com/dotnet/2022/maui/icons"
             x:Class="MauiFrontend.Views.SearchResultsPage"
             Title="Kết quả tìm kiếm"
             BackgroundColor="#FFFDFB">

    <Grid>
        <!-- ========== LỚP 1: NỘI DUNG CHÍNH ========== -->
        <ScrollView>
            <VerticalStackLayout Padding="16"
                                 Spacing="18">

                <!-- NAVIGATION HEADER -->
                <Grid ColumnDefinitions="Auto,*,Auto">
                    <mi:MauiIcon Icon="{mi:Material Icon=ArrowBack, IconColor=#111, IconSize=26}"
                                 VerticalOptions="Center">
                        <mi:MauiIcon.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding GoBackCommand}" />
                        </mi:MauiIcon.GestureRecognizers>
                    </mi:MauiIcon>

                    <Label Grid.Column="1"
                           Text="Kết quả tìm kiếm"
                           FontSize="20"
                           FontAttributes="Bold"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"
                           TextColor="#111" />
                </Grid>

                <!-- SEARCH INFO -->
                <VerticalStackLayout Spacing="4">
                    <Label Text="{Binding Keyword, StringFormat='Từ khóa: {0}'}"
                           FontSize="14"
                           TextColor="#666" />
                    <Label Text="{Binding ResultCount, StringFormat='Tìm thấy {0} sản phẩm'}"
                           FontSize="14"
                           FontAttributes="Bold"
                           TextColor="#1E88E5" />
                </VerticalStackLayout>

                <!-- PRODUCT LIST -->
                <!-- PRODUCT LIST -->
                <CollectionView ItemsSource="{Binding SearchResults}"
                                SelectionMode="None">

                    <CollectionView.ItemsLayout>
                        <GridItemsLayout Orientation="Vertical"
                                         Span="2"
                                         VerticalItemSpacing="10"
                                         HorizontalItemSpacing="10" />
                    </CollectionView.ItemsLayout>

                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Border BackgroundColor="#FFFDF9"
                                    StrokeShape="RoundRectangle 15"
                                    StrokeThickness="1"
                                    Stroke="#F3F3F3"
                                    Margin="4"
                                    Padding="5">
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:SearchResultsViewModel}}, Path=GoToDetailCommand}"
                                                          CommandParameter="{Binding ProductID}" />
                                </Border.GestureRecognizers>

                                <Grid RowDefinitions="Auto,Auto,Auto">
                                    <Border Grid.Row="0"
                                            StrokeShape="RoundRectangle 12"
                                            StrokeThickness="0"
                                            Margin="0,0,0,8"
                                            BackgroundColor="#FAFAFA">
                                        <Image Source="{Binding Thumbnail}"
                                               Aspect="AspectFill"
                                               HeightRequest="160"
                                               HorizontalOptions="Fill"
                                               VerticalOptions="Fill" />
                                    </Border>

                                    <Label Grid.Row="1"
                                           Text="{Binding Name}"
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           TextColor="#222"
                                           HorizontalOptions="Center"
                                           LineBreakMode="TailTruncation"
                                           MaxLines="1"
                                           Margin="0,2,0,0" />

                                    <Label Grid.Row="2"
                                           Text="{Binding Price, StringFormat='{0:N0} đ'}"
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           TextColor="#E53935"
                                           HorizontalOptions="Center"
                                           Margin="0,0,0,2" />
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </VerticalStackLayout>
        </ScrollView>

        <!-- ========== LỚP 2: LOADING OVERLAY ========== -->
        <Grid IsVisible="{Binding IsBusy}"
              BackgroundColor="#80000000"
              VerticalOptions="Fill"
              HorizontalOptions="Fill"
              ZIndex="10">
            <VerticalStackLayout VerticalOptions="Center"
                                 HorizontalOptions="Center"
                                 Spacing="14">
                <ActivityIndicator IsRunning="True"
                                   Color="White"
                                   WidthRequest="60"
                                   HeightRequest="60" />
                <Label Text="Đang tải sản phẩm..."
                       FontSize="16"
                       TextColor="White"
                       HorizontalOptions="Center" />
            </VerticalStackLayout>
        </Grid>
    </Grid>
</ContentPage>
